<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bioinformatics Job Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 20px;
      background: #fafafa;
      color: #111;
    }
    h1 {
      margin-bottom: 4px;
    }
    .sub {
      color: #555;
      margin-bottom: 16px;
    }
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    select, input {
      padding: 6px 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 13px;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      text-align: left;
      position: sticky;
      top: 0;
    }
    a {
      color: #0b57d0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
    }
    .status {
      margin-top: 8px;
      color: #555;
      font-size: 13px;
    }
    .error {
      color: #b00020;
    }
  </style>
</head>

<body>

<h1>Bioinformatics Job Tracker</h1>
<p class="sub">
  Automated ATS job tracking (Greenhouse, Lever, Ashby, iCIMS).
</p>

<div class="controls">
  <label>
    View:
    <select id="view">
      <option value="latest">Latest (new)</option>
      <option value="history">History (all)</option>
    </select>
  </label>

  <label>
    Search:
    <input id="search" type="search" placeholder="company, title, location…" />
  </label>
</div>

<table>
  <thead>
    <tr>
      <th>Company</th>
      <th>Job title</th>
      <th>Location</th>
      <th>Remote</th>
      <th>Posted</th>
      <th>Source</th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<div id="status" class="status">Loading…</div>

<script>
  const FILES = {
    latest: "data/jobs_latest.csv",
    history: "data/jobs_history.csv"
  };

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split(",");
    return lines.map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = (cols[i] || "").replace(/^"|"$/g, ""));
      return obj;
    });
  }

  function normalize(s) {
    return (s || "").toLowerCase();
  }

  function render(data) {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    for (const r of data) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.company || ""}</td>
        <td>${r.job_title || ""}</td>
        <td>${r.location || ""}</td>
        <td><span class="pill">${r.remote_or_hybrid || "unknown"}</span></td>
        <td>${r.posting_date || ""}</td>
        <td>${r.source || ""}</td>
        <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function load() {
    const view = document.getElementById("view").value;
    const status = document.getElementById("status");
    const search = normalize(document.getElementById("search").value);

    try {
      const res = await fetch(FILES[view], { cache: "no-store" });
      if (!res.ok) throw new Error("CSV not found");

      const text = await res.text();
      if (!text.trim()) {
        status.textContent = "No data available.";
        render([]);
        return;
      }

      let rows = parseCSV(text);

      if (search) {
        rows = rows.filter(r =>
          normalize(
            (r.company || "") +
            (r.job_title || "") +
            (r.location || "")
          ).includes(search)
        );
      }

      render(rows);
      status.textContent = `Showing ${rows.length} jobs (${view})`;
    } catch (e) {
      status.innerHTML = `<span class="error">Failed to load data.</span>`;
      render([]);
    }
  }

  document.getElementById("view").addEventListener("change", load);
  document.getElementById("search").addEventListener("input", load);

  load();
</script>

</body>
</html>
