<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bioinformatics Job Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 20px;
      background: #f2f2f2;
      color: #111;
    }
    h1 {
      margin: 0;
      font-size: 20px;
      line-height: 1.2;
    }
    .sub {
      color: #666;
      margin: 2px 0 0 0;
      font-size: 12px;
    }
    .header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .header .right {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .update-box {
      display: inline-flex;
      flex-direction: column;
      gap: 6px;
      background: linear-gradient(135deg, #ffffff, #f1f5f9);
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
      min-width: 220px;
    }
    .update-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #334155;
    }
    .update-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6);
      animation: pulse 2s infinite;
      flex: 0 0 auto;
    }
    .update-dot.next {
      background: #0ea5e9;
      box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.6);
      animation: pulse 2.4s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.5); }
      70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    .update-label {
      font-weight: 600;
      color: #0f172a;
    }
    @media (max-width: 720px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header .right {
        white-space: normal;
      }
      .update-box {
        width: 100%;
      }
      .update-row {
        font-size: 11px;
      }
    }
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .tab-bar {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    select, input {
      padding: 6px 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    .unfiltered-table {
      table-layout: fixed;
    }
    .unfiltered-table th,
    .unfiltered-table td {
      overflow-wrap: anywhere;
    }
    .unfiltered-table th:nth-child(1) { width: 16%; }
    .unfiltered-table th:nth-child(2) { width: 26%; }
    .unfiltered-table th:nth-child(3) { width: 18%; }
    .unfiltered-table th:nth-child(4) { width: 8%; }
    .unfiltered-table th:nth-child(5) { width: 10%; }
    .unfiltered-table th:nth-child(6) { width: 8%; }
    .unfiltered-table th:nth-child(7) { width: 8%; }
    .unfiltered-table th:nth-child(8) { width: 6%; }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 13px;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      text-align: left;
      position: sticky;
      top: 0;
    }
    th[data-sort] {
      cursor: pointer;
    }
    th[data-sort]:hover {
      background: #e6e6e6;
    }
    th[data-sort] .sort-indicator {
      margin-left: 6px;
      font-size: 11px;
      color: #666;
    }
    a {
      color: #0b57d0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
    }
    .pill.source {
      background: #e8f0fe;
      color: #174ea6;
    }
    .pill.sponsor-yes {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .pill.sponsor-no {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    .pill.score {
      background: #f3f4f6;
      color: #111827;
      border: 1px solid #e5e7eb;
    }
    .pill.recent {
      background: #e6f4ea;
      color: #137333;
    }
    .pill.stale {
      background: #fce8e6;
      color: #a50e0e;
    }
    tr.fresh {
      background: #f7fbf8;
    }
    .tab-btn {
      border: 1px solid #ccc;
      background: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #e9e9e9;
      font-weight: 600;
    }
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
    }
    .filter-box {
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 10px;
      padding: 14px;
      font-size: 12px;
      line-height: 1.5;
      overflow: auto;
      max-height: 520px;
      border: 1px solid #1f2937;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
    }
    .filter-box code {
      color: #93c5fd;
    }
    .filter-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .filter-card {
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1 1 260px;
      min-width: 220px;
    }
    .filter-card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 12px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }
    .filter-card h3 {
      margin: 0 0 8px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #334155;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-card h3::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
    }
    .filter-card ul {
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
      color: #334155;
    }
    .filter-card li {
      margin-bottom: 4px;
    }
    .filter-card .tag {
      display: inline-block;
      font-size: 11px;
      color: #0f172a;
      background: #e2e8f0;
      border: 1px solid #cbd5f5;
      border-radius: 999px;
      padding: 2px 8px;
      margin: 2px 4px 2px 0;
    }
    .status {
      margin-top: 8px;
      color: #555;
      font-size: 13px;
    }
    .error {
      color: #b00020;
    }
    .table-wrap {
      overflow-x: auto;
    }
    .card-view .table-wrap {
      overflow: visible;
    }
    .card-view table {
      border: none;
    }
    .card-view thead {
      display: none;
    }
    .card-view tbody tr {
      display: block;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 10px;
      padding: 8px;
      background: #fff;
    }
    .card-view tbody td {
      display: block;
      border: none;
      padding: 2px 0;
    }
    .card-view .card-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .card-view .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .card-view .card-title {
      font-weight: 600;
    }
    @media (max-width: 720px) {
      body {
        margin: 12px;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      select, input, .tab-btn {
        width: 100%;
      }
      .tab-bar {
        flex-direction: row;
        align-items: center;
      }
      .tab-bar .tab-btn {
        width: auto;
        flex: 0 0 auto;
      }
      th, td {
        font-size: 12px;
        padding: 6px;
      }
      th {
        position: static;
      }
      .card {
        padding: 10px;
      }
    }
    @media (min-width: 721px) {
      label.card-toggle {
        display: none;
      }
    }
  </style>
</head>

<body>

<div class="header">
  <h1>Bioinformatics Job Tracker</h1>
  <div class="right">
    <div class="update-box" aria-live="polite">
      <div class="update-row">
        <span class="update-dot" aria-hidden="true"></span>
        <span id="last-updated"><span class="update-label">Last updated:</span> Loading…</span>
      </div>
      <div class="update-row">
        <span class="update-dot next" aria-hidden="true"></span>
        <span id="next-run"><span class="update-label">Next run:</span> Calculating…</span>
      </div>
    </div>
    <div class="sub">Automated ATS job tracking (Greenhouse, Lever, Ashby, iCIMS)</div>
  </div>
</div>

<div class="controls card">
  <label>
    View:
    <select id="view">
      <option value="latest">Latest (new)</option>
      <option value="history">History (all)</option>
    </select>
  </label>

  <label>
    Sort:
    <select id="sort">
      <option value="date_desc">Posted (newest)</option>
      <option value="score_desc">Score (high)</option>
      <option value="score_asc">Score (low)</option>
      <option value="sponsor_desc">Sponsorship (Yes first)</option>
      <option value="sponsor_asc">Sponsorship (No first)</option>
      <option value="company_asc">Company (A-Z)</option>
      <option value="title_asc">Title (A-Z)</option>
    </select>
  </label>

  <label>
    Search:
    <input id="search" type="search" placeholder="company, title, location…" />
  </label>

  <label>
    Min score:
    <input id="minScore" type="number" min="0" step="1" value="0" />
  </label>

  <label>
    <input id="onlyRecent" type="checkbox" />
    Posted ≤ 7 days
  </label>

  <label>
    <input id="onlyRemote" type="checkbox" />
    Remote/Hybrid only
  </label>

  <label>
    <input id="hideNA" type="checkbox" />
    Hide NA dates
  </label>

  <label>
    <input id="strictBio" type="checkbox" checked />
    Strict bioinfo only
  </label>

  <label class="card-toggle">
    <input id="cardView" type="checkbox" />
    Card view
  </label>
</div>

<div class="controls card tab-bar">
  <button class="tab-btn" data-tab="jobs">Jobs</button>
  <button class="tab-btn" data-tab="unfiltered">Unfiltered Jobs</button>
  <button class="tab-btn" data-tab="targeted">Targeted List</button>
  <button class="tab-btn" data-tab="filter">Filter</button>
  <button class="tab-btn" data-tab="outputs">Outputs</button>
</div>

<div id="tab-jobs" class="tab-panel card">
<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>Company</th>
      <th>Job title</th>
      <th>Location</th>
      <th>Remote</th>
      <th>Posted</th>
      <th>Source</th>
      <th data-sort="sponsor">Sponsorship <span class="sort-indicator"></span></th>
      <th data-sort="score">Score <span class="sort-indicator"></span></th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>
</div>
</div>

<div id="tab-targeted" class="tab-panel card" hidden>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Company</th>
        <th>API</th>
        <th>URL</th>
        <th>List Source</th>
      </tr>
    </thead>
    <tbody id="targeted-rows"></tbody>
  </table>
  </div>
</div>

<div id="tab-filter" class="tab-panel card" hidden>
  <div id="filter-cards" class="filter-grid"></div>
</div>

<div id="tab-outputs" class="tab-panel card" hidden>
  <ul>
    <li><a href="data/jobs_latest.csv" target="_blank">jobs_latest.csv</a></li>
    <li><a href="data/jobs_latest.json" target="_blank">jobs_latest.json</a></li>
    <li><a href="data/jobs_history.csv" target="_blank">jobs_history.csv</a></li>
    <li><a href="data/jobs_unfiltered.jsonl" target="_blank">jobs_unfiltered.jsonl</a></li>
    <li><a href="data/jobs_filtered.jsonl" target="_blank">jobs_filtered.jsonl</a></li>
  </ul>
</div>

<div id="tab-unfiltered" class="tab-panel card" hidden>
  <div class="table-wrap">
  <table class="unfiltered-table">
    <thead>
      <tr>
        <th>Company</th>
        <th>Job title</th>
        <th>Location</th>
        <th>Remote</th>
      <th>Posted</th>
      <th>Source</th>
      <th>Sponsorship</th>
      <th>Link</th>
      </tr>
    </thead>
    <tbody id="unfiltered-rows"></tbody>
  </table>
  </div>
</div>

<div id="status" class="status">Loading…</div>

<script>
  const FILES = {
    latest: "data/jobs_latest.csv",
    history: "data/jobs_history.csv"
  };
  let sponsorSet = null;

  async function loadSponsors() {
    if (sponsorSet) return sponsorSet;
    sponsorSet = new Set();
    try {
      const res = await fetch("data/target_sponsor.json", { cache: "no-store" });
      if (!res.ok) return sponsorSet;
      const data = await res.json();
      for (const row of data) {
        if (row.company_name) sponsorSet.add(row.company_name.toLowerCase());
      }
    } catch (e) {
      return sponsorSet;
    }
    return sponsorSet;
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = parseCSVLine(lines.shift() || "");
    return lines.map(line => {
      const cols = parseCSVLine(line);
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = (cols[i] || "").replace(/^"|"$/g, ""));
      return obj;
    });
  }

  function parseCSVLine(line) {
    const out = [];
    let cur = "";
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"' && line[i + 1] === '"') {
        cur += '"';
        i++;
        continue;
      }
      if (ch === '"') {
        inQuotes = !inQuotes;
        continue;
      }
      if (ch === "," && !inQuotes) {
        out.push(cur);
        cur = "";
        continue;
      }
      cur += ch;
    }
    out.push(cur);
    return out;
  }

  function normalize(s) {
    return (s || "").toLowerCase();
  }

  function sponsorValue(row) {
    if (!sponsorSet) return 0;
    return sponsorSet.has((row.company || "").toLowerCase()) ? 1 : 0;
  }

  function parseDate(value) {
    if (!value || value === "NA") return null;
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  }

  const US_STATES = new Set([
    "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD",
    "MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC",
    "SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"
  ]);

  function isUSLocation(value) {
    const text = (value || "").toUpperCase();
    if (!text) return false;
    if (text.includes("UNITED STATES") || text.includes("USA") || /\bUS\b/.test(text)) return true;
    if (text.includes("WASHINGTON, DC") || text.includes("WASHINGTON, D.C.")) return true;
    const parts = text.split(",").map(s => s.trim());
    if (parts.length >= 2) {
      const state = parts[parts.length - 1].replace(/\./g, "").trim();
      if (US_STATES.has(state)) return true;
    }
    return false;
  }

  function isBioinfoTitle(title) {
    const t = (title || "").toLowerCase();
    return /bioinformatics|bioinformatic|computational|genomics|genomic|genome|omics|ngs|sequenc|transcript|rna|dna|proteom|variant|single cell|systems biology|bioinformatics analyst|bioinformatics engineer|computational biologist|computational scientist|data scientist|data science|machine learning|ml engineer|ai engineer|bioengineer|biostatistics|biostatistic|statistician|bioanalyst|informatics|genetics|geneticist|pipeline|workflow|clinical data|research scientist|research associate|scientist|bioinformatics pipelines|rna-seq|scRNA|scRNA-seq|single-cell|expression|multi-omics|multiomics|molecular/.test(t);
  }

  function isStrictBioinfoTitle(title) {
    const t = (title || "").toLowerCase();
    return /bioinformatics|bioinformatic|computational biology|computational biologist|genomics|genomic|genome|omics|ngs|sequenc|transcript|rna|dna|proteom|variant|single cell|single-cell|scRNA|scRNA-seq|rna-seq|multi-omics|multiomics|bioinformatics analyst|bioinformatics engineer/.test(t);
  }

  function daysAgo(date) {
    if (!date) return null;
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  }

  function render(data) {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    for (const r of data) {
      const tr = document.createElement("tr");
      const date = parseDate(r.posting_date);
      const age = daysAgo(date);
      if (age !== null && age <= 3) tr.classList.add("fresh");

      let datePill = "";
      if (age !== null && age <= 7) {
        datePill = `<span class="pill recent">${r.posting_date}</span>`;
      } else if (r.posting_date && r.posting_date !== "NA") {
        datePill = `<span class="pill stale">${r.posting_date}</span>`;
      } else {
        datePill = `${r.posting_date || "NA"}`;
      }
      const sponsor = sponsorSet && sponsorSet.has((r.company || "").toLowerCase());
      const sponsorPill = sponsor
        ? `<span class="pill sponsor-yes">Yes</span>`
        : `<span class="pill sponsor-no">No</span>`;
      const scorePill = `<span class="pill score">Score ${r.score || 0}</span>`;
      const isCard = document.body.classList.contains("card-view");
      if (isCard) {
        tr.innerHTML = `
          <td><span class="card-title">${r.company || ""}</span></td>
          <td>${r.job_title || ""}</td>
          <td>${r.location || ""}</td>
          <td class="card-meta">
            <span class="pill">${r.remote_or_hybrid || "unknown"}</span>
            ${datePill}
            <span class="pill source">${r.source || ""}</span>
            ${sponsorPill}
            ${scorePill}
          </td>
          <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
        `;
      } else {
        tr.innerHTML = `
          <td>${r.company || ""}</td>
          <td>${r.job_title || ""}</td>
          <td>${r.location || ""}</td>
          <td><span class="pill">${r.remote_or_hybrid || "unknown"}</span></td>
          <td>${datePill}</td>
          <td><span class="pill source">${r.source || ""}</span></td>
          <td>${sponsorPill}</td>
          <td>${r.score || ""}</td>
          <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
        `;
      }
      tbody.appendChild(tr);
    }
  }

  async function load() {
    const view = document.getElementById("view").value;
    const status = document.getElementById("status");
    const search = normalize(document.getElementById("search").value);
    const minScore = Number(document.getElementById("minScore").value || 0);
    const onlyRecent = document.getElementById("onlyRecent").checked;
    const onlyRemote = document.getElementById("onlyRemote").checked;
    const hideNA = document.getElementById("hideNA").checked;
    const sortMode = document.getElementById("sort").value;

    try {
      await loadSponsors();
      const res = await fetch(FILES[view], { cache: "no-store" });
      if (!res.ok) throw new Error("CSV not found");

      const text = await res.text();
      if (!text.trim()) {
        status.textContent = "No data available.";
        render([]);
        return;
      }

      let rows = parseCSV(text);

      if (search) {
        rows = rows.filter(r =>
          normalize(
            (r.company || "") +
            (r.job_title || "") +
            (r.location || "")
          ).includes(search)
        );
      }

      rows = rows.filter(r => {
        const score = Number(r.score || 0);
        if (score < minScore) return false;
        if (onlyRemote && !/remote|hybrid/i.test(r.remote_or_hybrid || "")) return false;
        if (hideNA && (!r.posting_date || r.posting_date === "NA")) return false;
        if (onlyRecent) {
          const date = parseDate(r.posting_date);
          const age = daysAgo(date);
          if (age === null || age > 7) return false;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortMode === "score_desc") {
          return Number(b.score || 0) - Number(a.score || 0);
        }
        if (sortMode === "score_asc") {
          return Number(a.score || 0) - Number(b.score || 0);
        }
        if (sortMode === "sponsor_desc") {
          const diff = sponsorValue(b) - sponsorValue(a);
          if (diff !== 0) return diff;
          return Number(b.score || 0) - Number(a.score || 0);
        }
        if (sortMode === "sponsor_asc") {
          const diff = sponsorValue(a) - sponsorValue(b);
          if (diff !== 0) return diff;
          return Number(b.score || 0) - Number(a.score || 0);
        }
        if (sortMode === "company_asc") {
          return (a.company || "").localeCompare(b.company || "");
        }
        if (sortMode === "title_asc") {
          return (a.job_title || "").localeCompare(b.job_title || "");
        }
        if (sortMode === "date_desc") {
          const da = parseDate(a.posting_date);
          const db = parseDate(b.posting_date);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return db - da;
        }
        return 0;
      });

      render(rows);
      status.textContent = `Showing ${rows.length} jobs (${view})`;
    } catch (e) {
      status.innerHTML = `<span class="error">Failed to load data.</span>`;
      render([]);
    }
  }

  async function loadTargeted() {
    const tbody = document.getElementById("targeted-rows");
    tbody.innerHTML = "";
    const files = [
      "data/targeted_list_combined.json",
      "data/targeted_list.json",
      "data/targeted_list_validation.json"
    ];
    for (const file of files) {
      try {
        const res = await fetch(file, { cache: "no-store" });
        if (!res.ok) continue;
        const data = await res.json();
        for (const row of data) {
          const api = row.api_name || row.original_api_name || "";
          const url = row.api_url || row.original_api_url || "";
          if (!row.company_name) continue;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.company_name}</td>
            <td>${api}</td>
            <td>${url ? `<a href="${url}" target="_blank">${url}</a>` : ""}</td>
            <td>${file.replace("data/", "")}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        continue;
      }
    }
  }

  async function loadFilter() {
    const container = document.getElementById("filter-cards");
    container.innerHTML = "";
    try {
      const res = await fetch("data/jobs_filter.json", { cache: "no-store" });
      if (!res.ok) throw new Error("filter not found");
      const data = await res.json();
      const sectionOrder = [
        "title_filter",
        "title_exclude",
        "location_filter",
        "employment_filter",
        "experience_filter",
        "global_exclusions",
        "keyword_scoring",
        "domain_gates",
        "hard_gates",
        "negative_keywords",
      ];
      const sections = [];
      for (const key of sectionOrder) {
        if (data[key]) sections.push([key, data[key]]);
      }
      for (const [key, value] of Object.entries(data)) {
        if (sectionOrder.includes(key)) continue;
        sections.push([key, value]);
      }
      for (const [key, value] of sections) {
        const card = document.createElement("div");
        card.className = "filter-card";
        const title = document.createElement("h3");
        title.textContent = key.replace(/_/g, " ");
        card.appendChild(title);
        if (Array.isArray(value)) {
          const list = document.createElement("ul");
          for (const item of value) {
            const li = document.createElement("li");
            li.textContent = String(item);
            list.appendChild(li);
          }
          card.appendChild(list);
        } else if (typeof value === "object" && value !== null) {
          const list = document.createElement("ul");
          for (const [k, v] of Object.entries(value)) {
            const li = document.createElement("li");
            if (Array.isArray(v)) {
              const tags = v.slice(0, 12).map(item => `<span class="tag">${item}</span>`).join("");
              li.innerHTML = `<strong>${k}:</strong> ${tags}${v.length > 12 ? ` <span class="tag">+${v.length - 12} more</span>` : ""}`;
            } else {
              li.innerHTML = `<strong>${k}:</strong> ${String(v)}`;
            }
            list.appendChild(li);
          }
          card.appendChild(list);
        } else {
          const p = document.createElement("div");
          p.textContent = String(value);
          card.appendChild(p);
        }
        container.appendChild(card);
      }
    } catch (e) {
      container.textContent = "Failed to load data/jobs_filter.json";
    }
  }

  function renderUnfiltered(data) {
    const tbody = document.getElementById("unfiltered-rows");
    tbody.innerHTML = "";
    for (const r of data) {
      const tr = document.createElement("tr");
      const date = parseDate(r.posting_date);
      const age = daysAgo(date);
      let datePill = "";
      if (age !== null && age <= 7) {
        datePill = `<span class="pill recent">${r.posting_date}</span>`;
      } else if (r.posting_date && r.posting_date !== "NA") {
        datePill = `<span class="pill stale">${r.posting_date}</span>`;
      } else {
        datePill = `${r.posting_date || "NA"}`;
      }
      const sponsor = sponsorSet && sponsorSet.has((r.company || "").toLowerCase());
      const sponsorPill = sponsor
        ? `<span class="pill sponsor-yes">Yes</span>`
        : `<span class="pill sponsor-no">No</span>`;
      const isCard = document.body.classList.contains("card-view");
      if (isCard) {
        tr.innerHTML = `
          <td><span class="card-title">${r.company || ""}</span></td>
          <td>${r.job_title || ""}</td>
          <td>${r.location || ""}</td>
          <td class="card-meta">
            <span class="pill">${r.remote_or_hybrid || "unknown"}</span>
            ${datePill}
            <span class="pill source">${r.source || ""}</span>
            ${sponsorPill}
          </td>
          <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
        `;
      } else {
        tr.innerHTML = `
          <td>${r.company || ""}</td>
          <td>${r.job_title || ""}</td>
          <td>${r.location || ""}</td>
          <td><span class="pill">${r.remote_or_hybrid || "unknown"}</span></td>
          <td>${datePill}</td>
          <td><span class="pill source">${r.source || ""}</span></td>
          <td>${sponsorPill}</td>
          <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
        `;
      }
      tbody.appendChild(tr);
    }
  }

  async function loadUnfiltered() {
    try {
      await loadSponsors();
      const res = await fetch("data/jobs_unfiltered.jsonl", { cache: "no-store" });
      if (!res.ok) throw new Error("unfiltered not found");
      const text = await res.text();
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      let rows = lines.map(line => JSON.parse(line));
      const search = normalize(document.getElementById("search").value);
      const strictBio = document.getElementById("strictBio").checked;
      if (search) {
        rows = rows.filter(r =>
          normalize(
            (r.company || "") +
            (r.job_title || "") +
            (r.location || "")
          ).includes(search)
        );
      }
      // Keep unfiltered view focused on US bioinformatics roles
      rows = rows.filter(r => isUSLocation(r.location || "") || /remote|hybrid/i.test(r.remote_or_hybrid || ""));
      rows = rows.filter(r => strictBio ? isStrictBioinfoTitle(r.job_title || "") : isBioinfoTitle(r.job_title || ""));
      renderUnfiltered(rows);
    } catch (e) {
      renderUnfiltered([]);
    }
  }

  let currentTab = "jobs";

  function switchTab(tab) {
    currentTab = tab;
    const panels = ["jobs", "targeted", "filter", "outputs", "unfiltered"];
    for (const name of panels) {
      const el = document.getElementById(`tab-${name}`);
      if (!el) continue;
      el.hidden = name !== tab;
    }
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });
    if (tab === "jobs") load();
    if (tab === "targeted") loadTargeted();
    if (tab === "filter") loadFilter();
    if (tab === "unfiltered") loadUnfiltered();
  }

  function refreshCurrent() {
    if (currentTab === "jobs") load();
    if (currentTab === "unfiltered") loadUnfiltered();
  }

  function getESTParts(date = new Date()) {
    const formatter = new Intl.DateTimeFormat("en-US", {
      timeZone: "America/New_York",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      hour12: false,
      weekday: "short"
    });
    const parts = formatter.formatToParts(date);
    const out = {};
    for (const p of parts) {
      if (p.type !== "literal") out[p.type] = p.value;
    }
    return out;
  }

  function formatEST(date) {
    return new Intl.DateTimeFormat("en-US", {
      timeZone: "America/New_York",
      month: "short",
      day: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    }).format(date);
  }

  function nextRunLabel() {
    const nowParts = getESTParts();
    const dayMap = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };
    const dayIdx = dayMap[nowParts.weekday] ?? 0;
    const nowMinutes = Number(nowParts.hour) * 60 + Number(nowParts.minute);
    const schedule = [
      { h: 8, m: 30 },
      { h: 12, m: 30 },
      { h: 17, m: 50 },
      { h: 21, m: 30 }
    ];
    const isSunday = dayIdx === 0;
    if (isSunday) {
      return "Mon 08:30 ET";
    }
    for (const slot of schedule) {
      if (slot.h * 60 + slot.m > nowMinutes) {
        return `Today ${String(slot.h).padStart(2, "0")}:${String(slot.m).padStart(2, "0")} ET`;
      }
    }
    const nextDay = dayIdx === 6 ? 1 : dayIdx + 1;
    const dayName = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][nextDay];
    return `${dayName} 08:30 ET`;
  }

  async function loadUpdateStatus() {
    const lastEl = document.getElementById("last-updated");
    const nextEl = document.getElementById("next-run");
    if (nextEl) nextEl.textContent = `Next run: ${nextRunLabel()}`;
    if (!lastEl) return;
    try {
      const res = await fetch(FILES.latest, { method: "HEAD", cache: "no-store" });
      const last = res.headers.get("Last-Modified");
      if (last) {
        const date = new Date(last);
        lastEl.textContent = `Last updated: ${formatEST(date)} ET`;
      } else {
        lastEl.textContent = "Last updated: Unknown";
      }
    } catch (e) {
      lastEl.textContent = "Last updated: Unknown";
    }
  }

  function updateSortIndicators() {
    const sortMode = document.getElementById("sort").value;
    const scoreInd = document.querySelector('th[data-sort="score"] .sort-indicator');
    const sponsorInd = document.querySelector('th[data-sort="sponsor"] .sort-indicator');
    if (scoreInd) scoreInd.textContent = sortMode === "score_desc" ? "↓" : sortMode === "score_asc" ? "↑" : "";
    if (sponsorInd) {
      sponsorInd.textContent = sortMode === "sponsor_desc" ? "↓" : sortMode === "sponsor_asc" ? "↑" : "";
    }
  }

  document.getElementById("view").addEventListener("change", refreshCurrent);
  document.getElementById("search").addEventListener("input", refreshCurrent);
  document.getElementById("sort").addEventListener("change", () => {
    updateSortIndicators();
    refreshCurrent();
  });
  document.getElementById("minScore").addEventListener("input", refreshCurrent);
  document.getElementById("onlyRecent").addEventListener("change", refreshCurrent);
  document.getElementById("onlyRemote").addEventListener("change", refreshCurrent);
  document.getElementById("hideNA").addEventListener("change", refreshCurrent);
  document.getElementById("strictBio").addEventListener("change", refreshCurrent);
  document.getElementById("cardView").addEventListener("change", e => {
    document.body.classList.toggle("card-view", e.target.checked);
  });
  document.querySelectorAll("th[data-sort]").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.dataset.sort;
      const select = document.getElementById("sort");
      let next = select.value;
      if (key === "score") {
        next = select.value === "score_desc" ? "score_asc" : "score_desc";
      } else if (key === "sponsor") {
        next = select.value === "sponsor_desc" ? "sponsor_asc" : "sponsor_desc";
      }
      select.value = next;
      updateSortIndicators();
      refreshCurrent();
    });
  });
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
  });

  const cardToggle = document.getElementById("cardView");
  const mq = window.matchMedia("(max-width: 720px)");
  if (cardToggle && mq.matches) {
    cardToggle.checked = true;
    document.body.classList.add("card-view");
  }
  if (cardToggle && !mq.matches) {
    cardToggle.checked = false;
    document.body.classList.remove("card-view");
  }
  if (cardToggle) {
    mq.addEventListener("change", e => {
      if (e.matches) {
        cardToggle.checked = true;
        document.body.classList.add("card-view");
      } else {
        cardToggle.checked = false;
        document.body.classList.remove("card-view");
      }
    });
  }
  updateSortIndicators();
  loadUpdateStatus();
  setInterval(loadUpdateStatus, 60 * 1000);
  switchTab("jobs");
</script>

</body>
</html>
