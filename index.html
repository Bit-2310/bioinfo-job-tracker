<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bioinformatics Job Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 20px;
      background: #f2f2f2;
      color: #111;
    }
    h1 {
      margin: 0;
      font-size: 20px;
      line-height: 1.2;
    }
    .sub {
      color: #666;
      margin: 2px 0 0 0;
      font-size: 12px;
    }
    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .header .right {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }
    @media (max-width: 720px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header .right {
        white-space: normal;
      }
    }
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    select, input {
      padding: 6px 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 13px;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      text-align: left;
      position: sticky;
      top: 0;
    }
    a {
      color: #0b57d0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
    }
    .pill.source {
      background: #e8f0fe;
      color: #174ea6;
    }
    .pill.recent {
      background: #e6f4ea;
      color: #137333;
    }
    .pill.stale {
      background: #fce8e6;
      color: #a50e0e;
    }
    tr.fresh {
      background: #f7fbf8;
    }
    .tab-btn {
      border: 1px solid #ccc;
      background: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #e9e9e9;
      font-weight: 600;
    }
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
    }
    .status {
      margin-top: 8px;
      color: #555;
      font-size: 13px;
    }
    .error {
      color: #b00020;
    }
    .table-wrap {
      overflow-x: auto;
    }
    @media (max-width: 720px) {
      body {
        margin: 12px;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      select, input, .tab-btn {
        width: 100%;
      }
      th, td {
        font-size: 12px;
        padding: 6px;
      }
      .card {
        padding: 10px;
      }
    }
  </style>
</head>

<body>

<div class="header">
  <h1>Bioinformatics Job Tracker</h1>
  <div class="right">Automated ATS job tracking (Greenhouse, Lever, Ashby, iCIMS)</div>
</div>

<div class="controls card">
  <label>
    View:
    <select id="view">
      <option value="latest">Latest (new)</option>
      <option value="history">History (all)</option>
    </select>
  </label>

  <label>
    Sort:
    <select id="sort">
      <option value="date_desc">Posted (newest)</option>
      <option value="score_desc">Score (high)</option>
      <option value="company_asc">Company (A-Z)</option>
      <option value="title_asc">Title (A-Z)</option>
    </select>
  </label>

  <label>
    Search:
    <input id="search" type="search" placeholder="company, title, location…" />
  </label>

  <label>
    Min score:
    <input id="minScore" type="number" min="0" step="1" value="0" />
  </label>

  <label>
    <input id="onlyRecent" type="checkbox" />
    Posted ≤ 7 days
  </label>

  <label>
    <input id="onlyRemote" type="checkbox" />
    Remote/Hybrid only
  </label>

  <label>
    <input id="hideNA" type="checkbox" />
    Hide NA dates
  </label>
</div>

<div class="controls card">
  <button class="tab-btn" data-tab="jobs">Jobs</button>
  <button class="tab-btn" data-tab="targeted">Targeted List</button>
  <button class="tab-btn" data-tab="filter">Filter</button>
  <button class="tab-btn" data-tab="outputs">Outputs</button>
  <button class="tab-btn" data-tab="unfiltered">Unfiltered Jobs</button>
</div>

<div id="tab-jobs" class="tab-panel card">
<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>Company</th>
      <th>Job title</th>
      <th>Location</th>
      <th>Remote</th>
      <th>Posted</th>
      <th>Source</th>
      <th>Score</th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>
</div>
</div>

<div id="tab-targeted" class="tab-panel card" hidden>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Company</th>
        <th>API</th>
        <th>URL</th>
        <th>List Source</th>
      </tr>
    </thead>
    <tbody id="targeted-rows"></tbody>
  </table>
  </div>
</div>

<div id="tab-filter" class="tab-panel card" hidden>
  <pre id="filter-json" style="white-space: pre-wrap;"></pre>
</div>

<div id="tab-outputs" class="tab-panel card" hidden>
  <ul>
    <li><a href="data/jobs_latest.csv" target="_blank">jobs_latest.csv</a></li>
    <li><a href="data/jobs_history.csv" target="_blank">jobs_history.csv</a></li>
    <li><a href="data/jobs_unfiltered.jsonl" target="_blank">jobs_unfiltered.jsonl</a></li>
    <li><a href="data/jobs_filtered.jsonl" target="_blank">jobs_filtered.jsonl</a></li>
  </ul>
</div>

<div id="tab-unfiltered" class="tab-panel card" hidden>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Company</th>
        <th>Job title</th>
        <th>Location</th>
        <th>Remote</th>
        <th>Posted</th>
        <th>Source</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody id="unfiltered-rows"></tbody>
  </table>
  </div>
</div>

<div id="status" class="status">Loading…</div>

<script>
  const FILES = {
    latest: "data/jobs_latest.csv",
    history: "data/jobs_history.csv"
  };

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split(",");
    return lines.map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = (cols[i] || "").replace(/^"|"$/g, ""));
      return obj;
    });
  }

  function normalize(s) {
    return (s || "").toLowerCase();
  }

  function parseDate(value) {
    if (!value || value === "NA") return null;
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  }

  function daysAgo(date) {
    if (!date) return null;
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  }

  function render(data) {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    for (const r of data) {
      const tr = document.createElement("tr");
      const date = parseDate(r.posting_date);
      const age = daysAgo(date);
      if (age !== null && age <= 3) tr.classList.add("fresh");

      let datePill = "";
      if (age !== null && age <= 7) {
        datePill = `<span class="pill recent">${r.posting_date}</span>`;
      } else if (r.posting_date && r.posting_date !== "NA") {
        datePill = `<span class="pill stale">${r.posting_date}</span>`;
      } else {
        datePill = `${r.posting_date || "NA"}`;
      }
      tr.innerHTML = `
        <td>${r.company || ""}</td>
        <td>${r.job_title || ""}</td>
        <td>${r.location || ""}</td>
        <td><span class="pill">${r.remote_or_hybrid || "unknown"}</span></td>
        <td>${datePill}</td>
        <td><span class="pill source">${r.source || ""}</span></td>
        <td>${r.score || ""}</td>
        <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function load() {
    const view = document.getElementById("view").value;
    const status = document.getElementById("status");
    const search = normalize(document.getElementById("search").value);
    const minScore = Number(document.getElementById("minScore").value || 0);
    const onlyRecent = document.getElementById("onlyRecent").checked;
    const onlyRemote = document.getElementById("onlyRemote").checked;
    const hideNA = document.getElementById("hideNA").checked;
    const sortMode = document.getElementById("sort").value;

    try {
      const res = await fetch(FILES[view], { cache: "no-store" });
      if (!res.ok) throw new Error("CSV not found");

      const text = await res.text();
      if (!text.trim()) {
        status.textContent = "No data available.";
        render([]);
        return;
      }

      let rows = parseCSV(text);

      if (search) {
        rows = rows.filter(r =>
          normalize(
            (r.company || "") +
            (r.job_title || "") +
            (r.location || "")
          ).includes(search)
        );
      }

      rows = rows.filter(r => {
        const score = Number(r.score || 0);
        if (score < minScore) return false;
        if (onlyRemote && !/remote|hybrid/i.test(r.remote_or_hybrid || "")) return false;
        if (hideNA && (!r.posting_date || r.posting_date === "NA")) return false;
        if (onlyRecent) {
          const date = parseDate(r.posting_date);
          const age = daysAgo(date);
          if (age === null || age > 7) return false;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortMode === "score_desc") {
          return Number(b.score || 0) - Number(a.score || 0);
        }
        if (sortMode === "company_asc") {
          return (a.company || "").localeCompare(b.company || "");
        }
        if (sortMode === "title_asc") {
          return (a.job_title || "").localeCompare(b.job_title || "");
        }
        if (sortMode === "date_desc") {
          const da = parseDate(a.posting_date);
          const db = parseDate(b.posting_date);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return db - da;
        }
        return 0;
      });

      render(rows);
      status.textContent = `Showing ${rows.length} jobs (${view})`;
    } catch (e) {
      status.innerHTML = `<span class="error">Failed to load data.</span>`;
      render([]);
    }
  }

  async function loadTargeted() {
    const tbody = document.getElementById("targeted-rows");
    tbody.innerHTML = "";
    const files = ["data/targeted_list.json", "data/targeted_list_validation.json"];
    for (const file of files) {
      try {
        const res = await fetch(file, { cache: "no-store" });
        if (!res.ok) continue;
        const data = await res.json();
        for (const row of data) {
          const api = row.api_name || row.original_api_name || "";
          const url = row.api_url || row.original_api_url || "";
          if (!row.company_name) continue;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.company_name}</td>
            <td>${api}</td>
            <td>${url ? `<a href="${url}" target="_blank">${url}</a>` : ""}</td>
            <td>${file.replace("data/", "")}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        continue;
      }
    }
  }

  async function loadFilter() {
    const pre = document.getElementById("filter-json");
    try {
      const res = await fetch("data/jobs_filter.json", { cache: "no-store" });
      if (!res.ok) throw new Error("filter not found");
      const data = await res.json();
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      pre.textContent = "Failed to load data/jobs_filter.json";
    }
  }

  function renderUnfiltered(data) {
    const tbody = document.getElementById("unfiltered-rows");
    tbody.innerHTML = "";
    for (const r of data) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.company || ""}</td>
        <td>${r.job_title || ""}</td>
        <td>${r.location || ""}</td>
        <td><span class="pill">${r.remote_or_hybrid || "unknown"}</span></td>
        <td>${r.posting_date || ""}</td>
        <td><span class="pill source">${r.source || ""}</span></td>
        <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadUnfiltered() {
    try {
      const res = await fetch("data/jobs_unfiltered.jsonl", { cache: "no-store" });
      if (!res.ok) throw new Error("unfiltered not found");
      const text = await res.text();
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      const rows = lines.map(line => JSON.parse(line));
      renderUnfiltered(rows);
    } catch (e) {
      renderUnfiltered([]);
    }
  }

  function switchTab(tab) {
    const panels = ["jobs", "targeted", "filter", "outputs", "unfiltered"];
    for (const name of panels) {
      const el = document.getElementById(`tab-${name}`);
      if (!el) continue;
      el.hidden = name !== tab;
    }
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });
    if (tab === "jobs") load();
    if (tab === "targeted") loadTargeted();
    if (tab === "filter") loadFilter();
    if (tab === "unfiltered") loadUnfiltered();
  }

  document.getElementById("view").addEventListener("change", load);
  document.getElementById("search").addEventListener("input", load);
  document.getElementById("sort").addEventListener("change", load);
  document.getElementById("minScore").addEventListener("input", load);
  document.getElementById("onlyRecent").addEventListener("change", load);
  document.getElementById("onlyRemote").addEventListener("change", load);
  document.getElementById("hideNA").addEventListener("change", load);
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
  });

  switchTab("jobs");
</script>

</body>
</html>
