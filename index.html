<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bioinformatics Job Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 20px;
      background: #f2f2f2;
      color: #111;
    }
    h1 {
      margin: 0;
      font-size: 20px;
      line-height: 1.2;
    }
    .sub {
      color: #666;
      margin: 2px 0 0 0;
      font-size: 12px;
    }
    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .header .right {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }
    @media (max-width: 720px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header .right {
        white-space: normal;
      }
    }
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .tab-bar {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    select, input {
      padding: 6px 8px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 13px;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      text-align: left;
      position: sticky;
      top: 0;
    }
    th[data-sort] {
      cursor: pointer;
    }
    th[data-sort]:hover {
      background: #e6e6e6;
    }
    th[data-sort] .sort-indicator {
      margin-left: 6px;
      font-size: 11px;
      color: #666;
    }
    a {
      color: #0b57d0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
    }
    .pill.source {
      background: #e8f0fe;
      color: #174ea6;
    }
    .pill.sponsor-yes {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    .pill.sponsor-no {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    .pill.score {
      background: #f3f4f6;
      color: #111827;
      border: 1px solid #e5e7eb;
    }
    .pill.recent {
      background: #e6f4ea;
      color: #137333;
    }
    .pill.stale {
      background: #fce8e6;
      color: #a50e0e;
    }
    tr.fresh {
      background: #f7fbf8;
    }
    .tab-btn {
      border: 1px solid #ccc;
      background: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #e9e9e9;
      font-weight: 600;
    }
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
    }
    .status {
      margin-top: 8px;
      color: #555;
      font-size: 13px;
    }
    .error {
      color: #b00020;
    }
    .table-wrap {
      overflow-x: auto;
    }
    .card-view .table-wrap {
      overflow: visible;
    }
    .card-view table {
      border: none;
    }
    .card-view thead {
      display: none;
    }
    .card-view tbody tr {
      display: block;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 10px;
      padding: 8px;
      background: #fff;
    }
    .card-view tbody td {
      display: block;
      border: none;
      padding: 2px 0;
    }
    .card-view .card-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .card-view .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .card-view .card-title {
      font-weight: 600;
    }
    @media (max-width: 720px) {
      body {
        margin: 12px;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      select, input, .tab-btn {
        width: 100%;
      }
      .tab-bar {
        flex-direction: row;
        align-items: center;
      }
      .tab-bar .tab-btn {
        width: auto;
        flex: 0 0 auto;
      }
      th, td {
        font-size: 12px;
        padding: 6px;
      }
      th {
        position: static;
      }
      .card {
        padding: 10px;
      }
    }
    @media (min-width: 721px) {
      label.card-toggle {
        display: none;
      }
    }
  </style>
</head>

<body>

<div class="header">
  <h1>Bioinformatics Job Tracker</h1>
  <div class="right">Automated ATS job tracking (Greenhouse, Lever, Ashby, iCIMS)</div>
</div>

<div class="controls card">
  <label>
    View:
    <select id="view">
      <option value="latest">Latest (new)</option>
      <option value="history">History (all)</option>
    </select>
  </label>

  <label>
    Sort:
    <select id="sort">
      <option value="date_desc">Posted (newest)</option>
      <option value="score_desc">Score (high)</option>
      <option value="score_asc">Score (low)</option>
      <option value="sponsor_desc">Sponsorship (Yes first)</option>
      <option value="sponsor_asc">Sponsorship (No first)</option>
      <option value="company_asc">Company (A-Z)</option>
      <option value="title_asc">Title (A-Z)</option>
    </select>
  </label>

  <label>
    Search:
    <input id="search" type="search" placeholder="company, title, location…" />
  </label>

  <label>
    Min score:
    <input id="minScore" type="number" min="0" step="1" value="0" />
  </label>

  <label>
    <input id="onlyRecent" type="checkbox" />
    Posted ≤ 7 days
  </label>

  <label>
    <input id="onlyRemote" type="checkbox" />
    Remote/Hybrid only
  </label>

  <label>
    <input id="hideNA" type="checkbox" />
    Hide NA dates
  </label>

  <label class="card-toggle">
    <input id="cardView" type="checkbox" />
    Card view
  </label>
</div>

<div class="controls card tab-bar">
  <button class="tab-btn" data-tab="jobs">Jobs</button>
  <button class="tab-btn" data-tab="targeted">Targeted List</button>
  <button class="tab-btn" data-tab="filter">Filter</button>
  <button class="tab-btn" data-tab="outputs">Outputs</button>
  <button class="tab-btn" data-tab="unfiltered">Unfiltered Jobs</button>
</div>

<div id="tab-jobs" class="tab-panel card">
<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>Company</th>
      <th>Job title</th>
      <th>Location</th>
      <th>Remote</th>
      <th>Posted</th>
      <th>Source</th>
      <th data-sort="sponsor">Sponsorship <span class="sort-indicator"></span></th>
      <th data-sort="score">Score <span class="sort-indicator"></span></th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>
</div>
</div>

<div id="tab-targeted" class="tab-panel card" hidden>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Company</th>
        <th>API</th>
        <th>URL</th>
        <th>List Source</th>
      </tr>
    </thead>
    <tbody id="targeted-rows"></tbody>
  </table>
  </div>
</div>

<div id="tab-filter" class="tab-panel card" hidden>
  <pre id="filter-json" style="white-space: pre-wrap;"></pre>
</div>

<div id="tab-outputs" class="tab-panel card" hidden>
  <ul>
    <li><a href="data/jobs_latest.csv" target="_blank">jobs_latest.csv</a></li>
    <li><a href="data/jobs_latest.json" target="_blank">jobs_latest.json</a></li>
    <li><a href="data/jobs_history.csv" target="_blank">jobs_history.csv</a></li>
    <li><a href="data/jobs_unfiltered.jsonl" target="_blank">jobs_unfiltered.jsonl</a></li>
    <li><a href="data/jobs_filtered.jsonl" target="_blank">jobs_filtered.jsonl</a></li>
  </ul>
</div>

<div id="tab-unfiltered" class="tab-panel card" hidden>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Company</th>
        <th>Job title</th>
        <th>Location</th>
        <th>Remote</th>
      <th>Posted</th>
      <th>Source</th>
      <th>Sponsorship</th>
      <th>Link</th>
      </tr>
    </thead>
    <tbody id="unfiltered-rows"></tbody>
  </table>
  </div>
</div>

<div id="status" class="status">Loading…</div>

<script>
  const FILES = {
    latest: "data/jobs_latest.csv",
    history: "data/jobs_history.csv"
  };
  let sponsorSet = null;

  async function loadSponsors() {
    if (sponsorSet) return sponsorSet;
    sponsorSet = new Set();
    try {
      const res = await fetch("data/target_sponsor.json", { cache: "no-store" });
      if (!res.ok) return sponsorSet;
      const data = await res.json();
      for (const row of data) {
        if (row.company_name) sponsorSet.add(row.company_name.toLowerCase());
      }
    } catch (e) {
      return sponsorSet;
    }
    return sponsorSet;
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = parseCSVLine(lines.shift() || "");
    return lines.map(line => {
      const cols = parseCSVLine(line);
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = (cols[i] || "").replace(/^"|"$/g, ""));
      return obj;
    });
  }

  function parseCSVLine(line) {
    const out = [];
    let cur = "";
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"' && line[i + 1] === '"') {
        cur += '"';
        i++;
        continue;
      }
      if (ch === '"') {
        inQuotes = !inQuotes;
        continue;
      }
      if (ch === "," && !inQuotes) {
        out.push(cur);
        cur = "";
        continue;
      }
      cur += ch;
    }
    out.push(cur);
    return out;
  }

  function normalize(s) {
    return (s || "").toLowerCase();
  }

  function sponsorValue(row) {
    if (!sponsorSet) return 0;
    return sponsorSet.has((row.company || "").toLowerCase()) ? 1 : 0;
  }

  function parseDate(value) {
    if (!value || value === "NA") return null;
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  }

  function daysAgo(date) {
    if (!date) return null;
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  }

  function render(data) {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    for (const r of data) {
      const tr = document.createElement("tr");
      const date = parseDate(r.posting_date);
      const age = daysAgo(date);
      if (age !== null && age <= 3) tr.classList.add("fresh");

      let datePill = "";
      if (age !== null && age <= 7) {
        datePill = `<span class="pill recent">${r.posting_date}</span>`;
      } else if (r.posting_date && r.posting_date !== "NA") {
        datePill = `<span class="pill stale">${r.posting_date}</span>`;
      } else {
        datePill = `${r.posting_date || "NA"}`;
      }
      const sponsor = sponsorSet && sponsorSet.has((r.company || "").toLowerCase());
      const sponsorPill = sponsor
        ? `<span class="pill sponsor-yes">Yes</span>`
        : `<span class="pill sponsor-no">No</span>`;
      const scorePill = `<span class="pill score">Score ${r.score || 0}</span>`;
      const isCard = document.body.classList.contains("card-view");
      if (isCard) {
        tr.innerHTML = `
          <td><span class="card-title">${r.company || ""}</span></td>
          <td>${r.job_title || ""}</td>
          <td>${r.location || ""}</td>
          <td class="card-meta">
            <span class="pill">${r.remote_or_hybrid || "unknown"}</span>
            ${datePill}
            <span class="pill source">${r.source || ""}</span>
            ${sponsorPill}
            ${scorePill}
          </td>
          <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
        `;
      } else {
        tr.innerHTML = `
          <td>${r.company || ""}</td>
          <td>${r.job_title || ""}</td>
          <td>${r.location || ""}</td>
          <td><span class="pill">${r.remote_or_hybrid || "unknown"}</span></td>
          <td>${datePill}</td>
          <td><span class="pill source">${r.source || ""}</span></td>
          <td>${sponsorPill}</td>
          <td>${r.score || ""}</td>
          <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
        `;
      }
      tbody.appendChild(tr);
    }
  }

  async function load() {
    const view = document.getElementById("view").value;
    const status = document.getElementById("status");
    const search = normalize(document.getElementById("search").value);
    const minScore = Number(document.getElementById("minScore").value || 0);
    const onlyRecent = document.getElementById("onlyRecent").checked;
    const onlyRemote = document.getElementById("onlyRemote").checked;
    const hideNA = document.getElementById("hideNA").checked;
    const sortMode = document.getElementById("sort").value;

    try {
      await loadSponsors();
      const res = await fetch(FILES[view], { cache: "no-store" });
      if (!res.ok) throw new Error("CSV not found");

      const text = await res.text();
      if (!text.trim()) {
        status.textContent = "No data available.";
        render([]);
        return;
      }

      let rows = parseCSV(text);

      if (search) {
        rows = rows.filter(r =>
          normalize(
            (r.company || "") +
            (r.job_title || "") +
            (r.location || "")
          ).includes(search)
        );
      }

      rows = rows.filter(r => {
        const score = Number(r.score || 0);
        if (score < minScore) return false;
        if (onlyRemote && !/remote|hybrid/i.test(r.remote_or_hybrid || "")) return false;
        if (hideNA && (!r.posting_date || r.posting_date === "NA")) return false;
        if (onlyRecent) {
          const date = parseDate(r.posting_date);
          const age = daysAgo(date);
          if (age === null || age > 7) return false;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortMode === "score_desc") {
          return Number(b.score || 0) - Number(a.score || 0);
        }
        if (sortMode === "score_asc") {
          return Number(a.score || 0) - Number(b.score || 0);
        }
        if (sortMode === "sponsor_desc") {
          const diff = sponsorValue(b) - sponsorValue(a);
          if (diff !== 0) return diff;
          return Number(b.score || 0) - Number(a.score || 0);
        }
        if (sortMode === "sponsor_asc") {
          const diff = sponsorValue(a) - sponsorValue(b);
          if (diff !== 0) return diff;
          return Number(b.score || 0) - Number(a.score || 0);
        }
        if (sortMode === "company_asc") {
          return (a.company || "").localeCompare(b.company || "");
        }
        if (sortMode === "title_asc") {
          return (a.job_title || "").localeCompare(b.job_title || "");
        }
        if (sortMode === "date_desc") {
          const da = parseDate(a.posting_date);
          const db = parseDate(b.posting_date);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return db - da;
        }
        return 0;
      });

      render(rows);
      status.textContent = `Showing ${rows.length} jobs (${view})`;
    } catch (e) {
      status.innerHTML = `<span class="error">Failed to load data.</span>`;
      render([]);
    }
  }

  async function loadTargeted() {
    const tbody = document.getElementById("targeted-rows");
    tbody.innerHTML = "";
    const files = ["data/targeted_list.json", "data/targeted_list_validation.json"];
    for (const file of files) {
      try {
        const res = await fetch(file, { cache: "no-store" });
        if (!res.ok) continue;
        const data = await res.json();
        for (const row of data) {
          const api = row.api_name || row.original_api_name || "";
          const url = row.api_url || row.original_api_url || "";
          if (!row.company_name) continue;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.company_name}</td>
            <td>${api}</td>
            <td>${url ? `<a href="${url}" target="_blank">${url}</a>` : ""}</td>
            <td>${file.replace("data/", "")}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        continue;
      }
    }
  }

  async function loadFilter() {
    const pre = document.getElementById("filter-json");
    try {
      const res = await fetch("data/jobs_filter.json", { cache: "no-store" });
      if (!res.ok) throw new Error("filter not found");
      const data = await res.json();
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      pre.textContent = "Failed to load data/jobs_filter.json";
    }
  }

  function renderUnfiltered(data) {
    const tbody = document.getElementById("unfiltered-rows");
    tbody.innerHTML = "";
    for (const r of data) {
      const tr = document.createElement("tr");
      const sponsor = sponsorSet && sponsorSet.has((r.company || "").toLowerCase());
      const sponsorPill = sponsor
        ? `<span class="pill sponsor-yes">Yes</span>`
        : `<span class="pill sponsor-no">No</span>`;
      tr.innerHTML = `
        <td><span class="card-title">${r.company || ""}</span></td>
        <td>${r.job_title || ""}</td>
        <td>${r.location || ""}</td>
        <td class="card-meta">
          <span class="pill">${r.remote_or_hybrid || "unknown"}</span>
          <span class="pill recent">${r.posting_date || ""}</span>
          <span class="pill source">${r.source || ""}</span>
          ${sponsorPill}
        </td>
        <td>${r.job_url ? `<a href="${r.job_url}" target="_blank">Open</a>` : ""}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadUnfiltered() {
    try {
      await loadSponsors();
      const res = await fetch("data/jobs_unfiltered.jsonl", { cache: "no-store" });
      if (!res.ok) throw new Error("unfiltered not found");
      const text = await res.text();
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      let rows = lines.map(line => JSON.parse(line));
      const search = normalize(document.getElementById("search").value);
      if (search) {
        rows = rows.filter(r =>
          normalize(
            (r.company || "") +
            (r.job_title || "") +
            (r.location || "")
          ).includes(search)
        );
      }
      renderUnfiltered(rows);
    } catch (e) {
      renderUnfiltered([]);
    }
  }

  let currentTab = "jobs";

  function switchTab(tab) {
    currentTab = tab;
    const panels = ["jobs", "targeted", "filter", "outputs", "unfiltered"];
    for (const name of panels) {
      const el = document.getElementById(`tab-${name}`);
      if (!el) continue;
      el.hidden = name !== tab;
    }
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });
    if (tab === "jobs") load();
    if (tab === "targeted") loadTargeted();
    if (tab === "filter") loadFilter();
    if (tab === "unfiltered") loadUnfiltered();
  }

  function refreshCurrent() {
    if (currentTab === "jobs") load();
    if (currentTab === "unfiltered") loadUnfiltered();
  }

  function updateSortIndicators() {
    const sortMode = document.getElementById("sort").value;
    const scoreInd = document.querySelector('th[data-sort="score"] .sort-indicator');
    const sponsorInd = document.querySelector('th[data-sort="sponsor"] .sort-indicator');
    if (scoreInd) scoreInd.textContent = sortMode === "score_desc" ? "↓" : sortMode === "score_asc" ? "↑" : "";
    if (sponsorInd) {
      sponsorInd.textContent = sortMode === "sponsor_desc" ? "↓" : sortMode === "sponsor_asc" ? "↑" : "";
    }
  }

  document.getElementById("view").addEventListener("change", refreshCurrent);
  document.getElementById("search").addEventListener("input", refreshCurrent);
  document.getElementById("sort").addEventListener("change", () => {
    updateSortIndicators();
    refreshCurrent();
  });
  document.getElementById("minScore").addEventListener("input", refreshCurrent);
  document.getElementById("onlyRecent").addEventListener("change", refreshCurrent);
  document.getElementById("onlyRemote").addEventListener("change", refreshCurrent);
  document.getElementById("hideNA").addEventListener("change", refreshCurrent);
  document.getElementById("cardView").addEventListener("change", e => {
    document.body.classList.toggle("card-view", e.target.checked);
  });
  document.querySelectorAll("th[data-sort]").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.dataset.sort;
      const select = document.getElementById("sort");
      let next = select.value;
      if (key === "score") {
        next = select.value === "score_desc" ? "score_asc" : "score_desc";
      } else if (key === "sponsor") {
        next = select.value === "sponsor_desc" ? "sponsor_asc" : "sponsor_desc";
      }
      select.value = next;
      updateSortIndicators();
      refreshCurrent();
    });
  });
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
  });

  const cardToggle = document.getElementById("cardView");
  const mq = window.matchMedia("(max-width: 720px)");
  if (cardToggle && mq.matches) {
    cardToggle.checked = true;
    document.body.classList.add("card-view");
  }
  if (cardToggle && !mq.matches) {
    cardToggle.checked = false;
    document.body.classList.remove("card-view");
  }
  if (cardToggle) {
    mq.addEventListener("change", e => {
      if (e.matches) {
        cardToggle.checked = true;
        document.body.classList.add("card-view");
      } else {
        cardToggle.checked = false;
        document.body.classList.remove("card-view");
      }
    });
  }
  updateSortIndicators();
  switchTab("jobs");
</script>

</body>
</html>
